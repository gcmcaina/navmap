<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not칤cias SP</title>
    <style>
        :root {
            --color-background: #1a1a2e;
            --color-surface: #16213e;
            --color-text: #ffffff;
            --color-text-secondary: #a0a0a0;
            --color-primary: #0f4c75;
            --color-accent: #3282b8;
            --color-border: rgba(255, 255, 255, 0.1);
            --color-alert: #ff4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--color-background);
            color: var(--color-text);
            overflow: hidden;
            height: 100vh;
        }

        .header {
            background: var(--color-surface);
            padding: 20px 40px;
            border-bottom: 2px solid var(--color-accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 { font-size: 2.5rem; color: var(--color-accent); }

        .carousel-container {
            height: calc(100vh - 100px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .news-card {
            background: var(--color-surface);
            border-radius: 20px;
            padding: 60px;
            max-width: 1500px;
            width: 100%;
            height: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--color-border);
            position: absolute;
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .news-card.active { opacity: 1; transform: translateY(0); }

        .news-title {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 30px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 252px;
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 6px;
            background: var(--color-accent);
            width: 0%;
        }

        /* Painel de Gest칚o */
        .manage-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(22, 33, 62, 0.8);
            color: white;
            border: 1px solid var(--color-accent);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            font-size: 0.8rem;
        }

        .news-manager-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--color-surface);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--color-accent);
            z-index: 1001;
            box-shadow: 0 0 50px rgba(0,0,0,0.9);
        }

        .custom-news-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px dashed var(--color-accent);
        }

        .custom-news-form input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #000;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
        }

        .manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--color-border);
        }

        .manager-item button {
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: white;
            font-size: 0.7rem;
        }

        .btn-hide { background: var(--color-alert); }
        .btn-restore { background: #28a745; }
        .btn-delete { background: #555; }
    </style>
</head>
<body>

    <div class="header">
        <h1>游뚮 Not칤cias SP</h1>
        <div style="text-align: right;">
            <div id="newsCounter">Carregando...</div>
            <div id="lastUpdate" style="font-size: 0.8rem; color: var(--color-text-secondary);"></div>
        </div>
    </div>

    <div class="carousel-container" id="carouselContainer">
        <div class="loading">Sincronizando feed...</div>
    </div>

    <div class="progress-bar" id="progressBar"></div>

    <button class="manage-btn" onclick="toggleManager()">丘뙖잺 Gerenciar</button>

    <div id="newsManager" class="news-manager-panel">
        <h2 style="margin-bottom: 20px;">Painel de Controle</h2>
        
        <div class="custom-news-form">
            <h4>游닉 Adicionar Not칤cia Personalizada</h4>
            <input type="text" id="customTitle" placeholder="T칤tulo da not칤cia...">
            <input type="text" id="customSource" placeholder="Fonte (Ex: RH, Seguran칞a)">
            <input type="text" id="customCategory" placeholder="Categoria (Ex: AVISO, EVENTO, URGENTE)">
            <button onclick="addCustomNews()" style="background: var(--color-accent); color:white; width: 100%; padding: 10px; margin-top: 10px; border:none; border-radius:5px; cursor:pointer;">Publicar no Tel칚o</button>
        </div>

        <h4>Gest칚o de Conte칰do</h4>
        <div id="managerList"></div>
        <button onclick="toggleManager()" style="margin-top:20px; padding: 10px; width: 100%; cursor:pointer;">Fechar</button>
    </div>

    <script>
        const FEEDS = [
            { url: 'https://g1.globo.com/dynamo/sp/sao-paulo/rss2.xml', name: 'G1', limit: 15 },
            { url: 'https://news.google.com/rss/search?q=S칚o%20Paulo&hl=pt-BR&gl=BR&ceid=BR%3Apt-419', name: 'Google News', limit: 15 },
            { url: 'https://rss.uol.com.br/feed/noticias.xml', name: 'UOL', limit: 10 }
        ];

        const WORKER_PROXY = 'https://news-fetcher.gcmcaina.workers.dev/?url=';
        const SLIDE_DURATION = 12000;
        
        let newsItems = [];
        let currentIndex = 0;
        let slideInterval, progressInterval;

        let hiddenNews = JSON.parse(localStorage.getItem('hiddenNews') || '[]');
        let customNews = JSON.parse(localStorage.getItem('customNews') || '[]');

        // Limpeza de acentua칞칚o e caracteres HTML
        function decodeHTMLEntities(text) {
            const textArea = document.createElement('textarea');
            textArea.innerHTML = text;
            return textArea.value;
        }

        function normalizeTitle(title) {
            return title.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 60);
        }

        function formatRelativeTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const now = new Date();
            const diffInSec = Math.floor((now - date) / 1000);

            if (diffInSec < 60) return `${diffInSec} segundos atr치s`;
            const diffInMin = Math.floor(diffInSec / 60);
            if (diffInMin < 60) return `${diffInMin} min atr치s`;
            const diffInHour = Math.floor(diffInMin / 60);
            if (diffInHour < 24) return `${diffInHour}h atr치s`;
            return `${Math.floor(diffInHour / 24)} dias atr치s`;
        }

        async function fetchNews() {
            try {
                const keywords = ['crime', 'assalto', 'roubo', 'pol칤cia', 'gcm', 'prefeitura', 'nunes', 'acidente', 'morte', 'pris칚o', 'operacao'];
                let allRSSItems = [];

                const results = await Promise.allSettled(FEEDS.map(f => fetch(WORKER_PROXY + encodeURIComponent(f.url)).then(r => r.text())));

                results.forEach((res, idx) => {
                    if (res.status === 'fulfilled') {
                        const xml = new DOMParser().parseFromString(res.value, 'text/xml');
                        const items = Array.from(xml.querySelectorAll('item, entry')).map(item => ({
                            title: decodeHTMLEntities(item.querySelector('title')?.textContent || ''),
                            pubDate: item.querySelector('pubDate, updated')?.textContent || '',
                            source: FEEDS[idx].name,
                            timestamp: new Date(item.querySelector('pubDate, updated')?.textContent).getTime() || 0,
                            category: 'S츾O PAULO'
                        }));

                        items.forEach(item => {
                            const norm = normalizeTitle(item.title);
                            const matches = keywords.some(k => item.title.toLowerCase().includes(k));
                            const isHidden = hiddenNews.includes(norm);
                            
                            if (matches && !isHidden && !allRSSItems.some(existing => normalizeTitle(existing.title) === norm)) {
                                allRSSItems.push(item);
                            }
                        });
                    }
                });

                newsItems = [...customNews, ...allRSSItems];
                newsItems.sort((a, b) => {
                    if (a.isCustom && !b.isCustom) return -1;
                    if (!a.isCustom && b.isCustom) return 1;
                    return b.timestamp - a.timestamp;
                });

                newsItems = newsItems.slice(0, 50);
                renderCarousel();
                startCarousel();
                updateLastUpdate();
            } catch (e) {
                setTimeout(fetchNews, 10000);
            }
        }

        function renderCarousel() {
            const container = document.getElementById('carouselContainer');
            if (newsItems.length === 0) {
                container.innerHTML = "<div>Sem not칤cias no momento.</div>";
                return;
            }

            container.innerHTML = newsItems.map((news, idx) => `
                <div class="news-card ${idx === 0 ? 'active' : ''}" data-index="${idx}">
                    <div style="margin-bottom:15px">
                        <span style="background:var(--color-accent); padding:5px 15px; border-radius:15px; font-size:0.8rem; font-weight:bold; text-transform: uppercase;">
                            ${news.category || 'NOT칈CIA'}
                        </span>
                    </div>
                    <h2 class="news-title">${news.title}</h2>
                    <div style="display:flex; gap:20px; color:var(--color-text-secondary); border-top:1px solid var(--color-border); padding-top:15px">
                        <span style="color:var(--color-accent); font-weight:bold">${news.source}</span>
                        <span>${news.isCustom ? formatRelativeTime(news.pubDate) : new Date(news.pubDate).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                </div>
            `).join('');
            
            currentIndex = 0;
            updateCounter();
        }

        function addCustomNews() {
            const title = document.getElementById('customTitle').value;
            const source = document.getElementById('customSource').value;
            const category = document.getElementById('customCategory').value;
            if (!title) return;

            const newItem = {
                title: decodeHTMLEntities(title),
                source: source || 'Comunicado',
                category: category || 'AVISO',
                pubDate: new Date().toISOString(),
                timestamp: Date.now(),
                isCustom: true
            };

            customNews.push(newItem);
            localStorage.setItem('customNews', JSON.stringify(customNews));
            
            // Limpa campos
            document.getElementById('customTitle').value = '';
            document.getElementById('customSource').value = '';
            document.getElementById('customCategory').value = '';
            
            fetchNews();
            toggleManager();
        }

        function hideNewsItem(title) {
            hiddenNews.push(normalizeTitle(title));
            localStorage.setItem('hiddenNews', JSON.stringify(hiddenNews));
            fetchNews();
        }

        function restoreNewsItem(norm) {
            hiddenNews = hiddenNews.filter(n => n !== norm);
            localStorage.setItem('hiddenNews', JSON.stringify(hiddenNews));
            fetchNews();
        }

        function deleteCustom(idx) {
            customNews.splice(idx, 1);
            localStorage.setItem('customNews', JSON.stringify(customNews));
            fetchNews();
        }

        function toggleManager() {
            const p = document.getElementById('newsManager');
            p.style.display = p.style.display === 'block' ? 'none' : 'block';
            if (p.style.display === 'block') renderManagerList();
        }

        function renderManagerList() {
            const list = document.getElementById('managerList');
            let html = '<p style="font-size:0.8rem; color:var(--color-accent); margin-bottom:10px">Fixas:</p>';
            customNews.forEach((n, i) => {
                html += `<div class="manager-item"><span>游늷 ${n.title.substring(0,40)}...</span><button class="btn-delete" onclick="deleteCustom(${i})">Remover</button></div>`;
            });

            html += '<p style="font-size:0.8rem; color:var(--color-accent); margin:15px 0 10px">Vis칤veis (RSS):</p>';
            newsItems.filter(n => !n.isCustom).forEach(n => {
                html += `<div class="manager-item"><span>${n.title.substring(0,40)}...</span><button class="btn-hide" onclick="hideNewsItem('${n.title.replace(/'/g, "\\'")}')">Ocultar</button></div>`;
            });

            html += '<p style="font-size:0.8rem; color:var(--color-accent); margin:15px 0 10px">Ocultas:</p>';
            hiddenNews.forEach(norm => {
                html += `<div class="manager-item" style="opacity:0.5"><span>ID: ${norm}</span><button class="btn-restore" onclick="restoreNewsItem('${norm}')">Restaurar</button></div>`;
            });
            list.innerHTML = html;
        }

        function startCarousel() {
            if (slideInterval) clearInterval(slideInterval);
            slideInterval = setInterval(() => {
                const cards = document.querySelectorAll('.news-card');
                if(!cards.length) return;
                cards[currentIndex].classList.remove('active');
                currentIndex = (currentIndex + 1) % newsItems.length;
                cards[currentIndex].classList.add('active');
                updateCounter();
            }, SLIDE_DURATION);

            if (progressInterval) clearInterval(progressInterval);
            let p = 0;
            progressInterval = setInterval(() => {
                p += 1;
                document.getElementById('progressBar').style.width = (p % 101) + '%';
            }, SLIDE_DURATION / 100);
        }

        function updateCounter() {
            document.getElementById('newsCounter').textContent = `${currentIndex + 1} / ${newsItems.length}`;
        }

        function updateLastUpdate() {
            document.getElementById('lastUpdate').textContent = "Sincronizado: " + new Date().toLocaleTimeString();
        }

        function scheduleUpdates() {
            const now = new Date();
            const mins = now.getMinutes();
            const wait = (mins < 30 ? 30 - mins : 60 - mins) * 60 * 1000 - (now.getSeconds() * 1000);
            setTimeout(() => { fetchNews(); setInterval(fetchNews, 30 * 60 * 1000); }, wait);
        }

        fetchNews();
        scheduleUpdates();
    </script>
</body>
</html>

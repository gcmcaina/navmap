<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notícias SP – Segurança</title>
  <style>
    :root {
      --bg:#0b0f14;
      --card:#121821;
      --text:#e8eef7;
      --muted:#a9b7c6;
      --accent:#2dd4bf;
      --accent-2:#60a5fa;
      --danger:#f87171;
    }
    html,body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--text);
      font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      overflow:hidden;
    }
    .wrap {
      display:grid; grid-template-rows:auto 1fr auto; height:100vh; padding:24px;
      gap:16px;
    }
    header {
      display:flex; align-items:flex-end; justify-content:space-between; gap:16px;
    }
    .title {
      font-size:2rem; letter-spacing:.5px; margin:0;
    }
    .meta {
      display:flex; gap:18px; align-items:center; color:var(--muted);
      font-size:1.1rem;
    }
    .badge {
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#012; padding:6px 12px; border-radius:999px; font-weight:600;
    }
    .last-update { opacity:.85; }
    .carousel {
      position:relative; width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
    }
    .card {
      width:92%; max-width:1600px; min-height:55vh;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0));
      border:1px solid rgba(255,255,255,0.08);
      border-radius:20px; padding:32px 36px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      display:flex; flex-direction:column; justify-content:center; gap:18px;
      transform:translateZ(0);
    }
    .source-row {
      display:flex; align-items:center; gap:14px; color:var(--muted);
      font-weight:600; letter-spacing:.3px;
      font-size:1.4rem; /* aumentado: tamanho da fonte da fonte (veículo) */
    }
    .dot { width:10px; height:10px; border-radius:50%; background:var(--accent); }
    .headline {
      font-size:3.2rem; line-height:1.15; margin:0;
      font-weight:800; letter-spacing:.2px;
    }
    .info-row {
      display:flex; align-items:center; gap:16px; color:var(--muted);
      font-size:1.4rem; /* aumentado: horário maior */
    }
    .counter { color:var(--muted); font-weight:600; }
    .controls { display:flex; align-items:center; gap:10px; }
    .hint { color:var(--muted); font-size:1rem; }
    .progress {
      height:6px; width:100%; background:rgba(255,255,255,0.08);
      border-radius:999px; overflow:hidden;
    }
    .bar {
      height:100%; width:0%;
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      transition:width .2s linear;
    }
    .error {
      color:var(--danger); font-weight:600; font-size:1.2rem;
    }
    @media (max-width:1200px) {
      .headline { font-size:2.4rem; }
      .source-row { font-size:1.2rem; }
      .info-row { font-size:1.2rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 class="title">Últimas notícias de São Paulo</h1>
      <div class="meta">
        <span class="badge">Carrossel</span>
        <span class="last-update" id="lastUpdate">Atualizando…</span>
      </div>
    </header>

    <main class="carousel">
      <div class="card" id="card">
        <div class="source-row">
          <span class="dot"></span>
          <span id="source">—</span>
        </div>
        <h2 class="headline" id="headline">Carregando…</h2>
        <div class="info-row">
          <span id="pubtime">—</span>
        </div>
        <div class="controls">
          <span class="counter" id="counter">0 / 0</span>
          <span class="hint">Use ← → para navegar</span>
        </div>
        <div class="progress"><div class="bar" id="bar"></div></div>
        <div class="error" id="error" style="display:none"></div>
      </div>
    </main>

    <footer class="meta">
      <span>Fontes: G1 São Paulo; Google Notícias tópico São Paulo</span>
    </footer>
  </div>

  <script>
    // CONFIGURAÇÕES
    const SOURCES = [
      {
        name: "g1 São Paulo",
        url: "https://g1.globo.com/dynamo/sao-paulo/rss2.xml" // feed oficial SP
      },
      {
        name: "Google Notícias (São Paulo)",
        url: "https://news.google.com/rss/topics/CAAqHAgKIhZDQklTQ2pvSWJHOWpZV3hmZGpJb0FBUAE/sections/CAQiUENCSVNOam9JYkc5allXeGZkakpDRUd4dlkyRnNYM1l5WDNObFkzUnBiMjV5Q3hJSkwyMHZNREl5Y0dadGVnc0tDUzl0THpBeU1uQm1iU2dBKjEIACotCAoiJ0NCSVNGem9JYkc5allXeGZkako2Q3dvSkwyMHZNREl5Y0dadEtBQVABUAE?hl=pt-BR&gl=BR&ceid=BR%3Apt-419"
      }
    ];
    const MAX_PER_SOURCE = 20;         // últimas 20 por fonte
    const SLIDE_MS = 10000;            // 10s por item
    const REFRESH_MS = 10 * 60 * 1000; // 10 minutos
    const CORS_PROXY = "https://r.jina.ai/http/"; // proxy leitura-anônima (somente GET)

    // Palavras-chave relacionadas a crime/segurança
    const CRIME_KEYWORDS = [
      "crime","crimes","assalto","assaltos","roubo","roubos","furto","furtos",
      "homicídio","homicidios","homicídios","latrocínio","latrocínios","sequestro",
      "sequestr","tiroteio","tiros","facção","facções","PCC","milícia","milícias",
      "tráfico","traficante","traficantes","fuga","cadeia","presídio","polícia",
      "policial","viatura","investigação","investiga","operação","bala perdida",
      "carro-forte","arrastão","golpe","estelionato","estupro","feminicídio"
    ];

    const el = {
      source: document.getElementById("source"),
      headline: document.getElementById("headline"),
      pubtime: document.getElementById("pubtime"),
      counter: document.getElementById("counter"),
      bar: document.getElementById("bar"),
      lastUpdate: document.getElementById("lastUpdate"),
      error: document.getElementById("error")
    };

    let queue = []; // itens intercalados
    let idx = 0;
    let timer = null;
    let barTimer = null;

    function fmtDate(d) {
      try {
        const dt = new Date(d);
        return dt.toLocaleString("pt-BR", { hour12:false });
      } catch { return d || "—"; }
    }

    function hasCrimeKeyword(text) {
      if (!text) return false;
      const t = text.toLowerCase();
      return CRIME_KEYWORDS.some(k => t.includes(k.toLowerCase()));
    }

    async function fetchText(url) {
      const res = await fetch(CORS_PROXY + url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    }

    function parseRSS(xmlString, sourceName) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlString, "text/xml");

      // Itens podem estar em <item> (RSS) ou <entry> (Atom)
      const items = [...doc.querySelectorAll("item, entry")].map(it => {
        const title = it.querySelector("title")?.textContent?.trim() || "";
        // Links: RSS <link>, Atom <link href="">
        let link = it.querySelector("link")?.getAttribute?.("href") || it.querySelector("link")?.textContent || "";
        // Datas: pubDate (RSS) ou updated/published (Atom)
        const pub = it.querySelector("pubDate, updated, published")?.textContent || "";

        return { title, link, pub, source: sourceName };
      });

      // Foco em crime apenas pelo título
      const filtered = items.filter(i => hasCrimeKeyword(i.title));

      // Pega as últimas 20 (ordena por data quando possível)
      const dated = filtered.map(i => ({...i, ts: Date.parse(i.pub || "") || 0 }));
      dated.sort((a,b)=> b.ts - a.ts);
      return dated.slice(0, MAX_PER_SOURCE);
    }

    function interleave(arrays) {
      const out = [];
      let more = true;
      let i = 0;
      while (more) {
        more = false;
        for (const a of arrays) {
          if (i < a.length) {
            out.push(a[i]);
            more = true;
          }
        }
        i++;
      }
      return out;
    }

    function setError(msg) {
      el.error.textContent = msg;
      el.error.style.display = msg ? "block" : "none";
    }

    function renderCurrent() {
      if (!queue.length) {
        el.source.textContent = "—";
        el.headline.textContent = "Sem notícias no momento (verifique filtros).";
        el.pubtime.textContent = "—";
        el.counter.textContent = "0 / 0";
        return;
      }
      const item = queue[idx % queue.length];
      el.source.textContent = item.source;
      el.headline.textContent = item.title;
      el.headline.onclick = () => { if (item.link) window.open(item.link, "_blank"); };
      el.pubtime.textContent = item.pub ? fmtDate(item.pub) : "—";
      el.counter.textContent = `${(idx % queue.length)+1} / ${queue.length}`;

      // Reinicia barra de progresso
      el.bar.style.width = "0%";
      if (barTimer) clearInterval(barTimer);
      const start = Date.now();
      barTimer = setInterval(()=>{
        const pct = Math.min(100, ((Date.now()-start)/SLIDE_MS)*100);
        el.bar.style.width = pct + "%";
        if (pct >= 100) clearInterval(barTimer);
      }, 100);
    }

    function startCarousel() {
      if (timer) clearInterval(timer);
      timer = setInterval(()=>{
        idx = (idx + 1) % Math.max(queue.length, 1);
        renderCurrent();
      }, SLIDE_MS);
      renderCurrent();
    }

    async function refreshAll() {
      try {
        setError("");
        const results = await Promise.allSettled(
          SOURCES.map(async s => {
            const txt = await fetchText(s.url);
            return parseRSS(txt, s.name);
          })
        );
        const arrays = results.map(r => Array.isArray(r.value) ? r.value : []);
        const inter = interleave(arrays);
        queue = inter;
        idx = 0;
        el.lastUpdate.textContent = "Atualizado: " + fmtDate(new Date());
        startCarousel();

        if (!queue.length) {
          setError("Nenhum item após aplicar filtros de crime. Ajuste as palavras‑chave se necessário.");
        }
      } catch (e) {
        setError("Falha ao atualizar feeds: " + (e.message || e.toString()));
      }
    }

    // Navegação manual
    window.addEventListener("keydown", (ev)=>{
      if (!queue.length) return;
      if (ev.key === "ArrowRight") { idx = (idx+1) % queue.length; renderCurrent(); }
      if (ev.key === "ArrowLeft")  { idx = (idx-1+queue.length) % queue.length; renderCurrent(); }
    });

    // Inicialização
    refreshAll();
    setInterval(refreshAll, REFRESH_MS);
  </script>
</body>
</html>
